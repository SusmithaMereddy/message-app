name: Deploy to Azure Container Apps (multi-env)

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: 'Target environment (dev, qa, staging, prod)'
        required: true
        type: choice
        options:
          - dev
          - qa
          - staging
          - prod
        default: dev
      image_tag:
        description: 'Image tag to deploy (sha or latest)'
        required: false
        default: 'latest'

env:
  BACKEND_IMAGE_NAME: backend-app-susmitha
  FRONTEND_IMAGE_NAME: frontend-app-susmitha

  # SAME resource group for all environments
  RESOURCE_GROUP: exr-dvo-intern-inc
  LOCATION: centralindia

jobs:
  deploy:
    runs-on: ubuntu-22.04

    # Use GitHub environments (dev/qa/staging/prod)
    environment: ${{ github.event.inputs.target_env }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Environment Variables
        id: vars
        run: |
          TARGET="${{ github.event.inputs.target_env }}"
          TAG="${{ github.event.inputs.image_tag }}"

          # ACA environment name PER environment
          ACA_ENV_NAME="messageapp-env-${TARGET}"

          # App names PER environment
          BACKEND_APP_NAME="message-app-backend-${TARGET}"
          FRONTEND_APP_NAME="message-app-frontend-${TARGET}"

          echo "target=$TARGET" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "aca_env_name=$ACA_ENV_NAME" >> "$GITHUB_OUTPUT"
          echo "backend_app_name=$BACKEND_APP_NAME" >> "$GITHUB_OUTPUT"
          echo "frontend_app_name=$FRONTEND_APP_NAME" >> "$GITHUB_OUTPUT"

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Container Apps Extension
        run: |
          az extension add --name containerapp --yes || az extension update --name containerapp

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Deploy Backend App
        run: |
          ACR="${{ secrets.ACR_LOGIN_SERVER }}"
          IMAGE="$ACR/${{ env.BACKEND_IMAGE_NAME }}:${{ steps.vars.outputs.tag }}"
          RG="${{ env.RESOURCE_GROUP }}"
          ENV_NAME="${{ steps.vars.outputs.aca_env_name }}"
          APP_NAME="${{ steps.vars.outputs.backend_app_name }}"

          echo "Using backend image: $IMAGE"

          # Create ACA environment if it doesn't exist
          if ! az containerapp env show -n "$ENV_NAME" -g "$RG" >/dev/null 2>&1; then
            echo "Creating ACA environment: $ENV_NAME"
            az containerapp env create \
              --name "$ENV_NAME" \
              --resource-group "$RG" \
              --location "${{ env.LOCATION }}"
          fi

          # Create or update the backend ACA
          if az containerapp show -n "$APP_NAME" -g "$RG" >/dev/null 2>&1; then
            echo "Backend exists → Updating image"
            az containerapp update -n "$APP_NAME" -g "$RG" --image "$IMAGE"
          else
            echo "Backend does not exist → Creating"
            az containerapp create \
              --name "$APP_NAME" \
              --resource-group "$RG" \
              --environment "$ENV_NAME" \
              --image "$IMAGE" \
              --registry-server "$ACR" \
              --registry-username "${{ secrets.ACR_USERNAME }}" \
              --registry-password "${{ secrets.ACR_PASSWORD }}" \
              --target-port 8080 \
              --ingress internal \
              --env-vars JAVA_TOOL_OPTIONS="-Duser.timezone=Asia/Calcutta"
          fi

      - name: Deploy Frontend App
        run: |
          ACR="${{ secrets.ACR_LOGIN_SERVER }}"
          IMAGE="$ACR/${{ env.FRONTEND_IMAGE_NAME }}:${{ steps.vars.outputs.tag }}"
          RG="${{ env.RESOURCE_GROUP }}"
          ENV_NAME="${{ steps.vars.outputs.aca_env_name }}"
          BACKEND_APP_NAME="${{ steps.vars.outputs.backend_app_name }}"
          FRONTEND_APP_NAME="${{ steps.vars.outputs.frontend_app_name }}"

          BACKEND_FQDN=$(az containerapp show -n "$BACKEND_APP_NAME" -g "$RG" --query "properties.configuration.ingress.fqdn" -o tsv || echo "")

          if [ -z "$BACKEND_FQDN" ]; then
            BACKEND_URL=""
          else
            BACKEND_URL="https://$BACKEND_FQDN"
          fi

          echo "Frontend connecting to BACKEND_URL=$BACKEND_URL"

          if az containerapp show -n "$FRONTEND_APP_NAME" -g "$RG" >/dev/null 2>&1; then
            echo "Updating frontend image + env"
            az containerapp update \
              --name "$FRONTEND_APP_NAME" \
              --resource-group "$RG" \
              --image "$IMAGE" \
              --set-env-vars BACKEND_URL="$BACKEND_URL"
          else
            echo "Creating frontend container app"
            az containerapp create \
              --name "$FRONTEND_APP_NAME" \
              --resource-group "$RG" \
              --environment "$ENV_NAME" \
              --image "$IMAGE" \
              --registry-server "$ACR" \
              --registry-username "${{ secrets.ACR_USERNAME }}" \
              --registry-password "${{ secrets.ACR_PASSWORD }}" \
              --target-port 80 \
              --ingress external

            az containerapp update \
              --name "$FRONTEND_APP_NAME" \
              --resource-group "$RG" \
              --set-env-vars BACKEND_URL="$BACKEND_URL"
          fi

          FRONTEND_FQDN=$(az containerapp show -n "$FRONTEND_APP_NAME" -g "$RG" --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "Frontend URL: https://$FRONTEND_FQDN"
