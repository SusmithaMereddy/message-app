name: Deploy Application to Azure Container Apps

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g., latest or a specific commit SHA)"
        required: true
        default: "latest"
  workflow_run:
    workflows: ["Build and Push Docker Images to ACR"]
    types: [completed]
    branches: [main]

env:
  RESOURCE_GROUP: "exr-dvo-intern-inc"
  ACA_ENV_NAME: "messageapp-env-susmitha"
  MONGO_APP_NAME: "mongo-app-susmitha"
  BACKEND_APP_NAME: "backend-app-susmitha"
  FRONTEND_APP_NAME: "frontend-app-susmitha"

jobs:
  deploy-mongo:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      mongo_fqdn: ${{ steps.deploy-mongo-container.outputs.fqdn }}
      
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Mongo Container App
        id: deploy-mongo-container
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: ${{ env.MONGO_APP_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.ACA_ENV_NAME }}
          imageToDeploy: mongo:latest
          
          ingress: "internal"
          targetPort: 27017
          
          cpu: "0.5"
          memory: "1.0Gi"
          
          startupProbe:
            type: "tcp"
            port: 27017
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 18

          environmentVariables: |
            MONGO_INITDB_ROOT_USERNAME=${{ secrets.MONGO_USERNAME }}
            MONGO_INITDB_ROOT_PASSWORD=${{ secrets.MONGO_PASSWORD }}

  deploy-backend:
    needs: deploy-mongo
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      backend_fqdn: ${{ steps.deploy-backend-container.outputs.fqdn }}

    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Determine Image Tag
        id: get_tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Deploy Backend Container App
        id: deploy-backend-container
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: ${{ env.BACKEND_APP_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.ACA_ENV_NAME }}
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.BACKEND_APP_NAME }}:${{ steps.get_tag.outputs.tag }}

          registryUrl: ${{ secrets.ACR_LOGIN_SERVER }}
          registryUsername: ${{ secrets.ACR_USERNAME }}
          registryPassword: ${{ secrets.ACR_PASSWORD }}

          targetPort: 8080
          ingress: "internal"
          
          environmentVariables: |
            JAVA_TOOL_OPTIONS=-Duser.timezone=Asia/Calcutta
            SPRING_DATA_MONGODB_URI=mongodb://${{ secrets.MONGO_USERNAME }}:${{ secrets.MONGO_PASSWORD }}@${{ needs.deploy-mongo.outputs.mongo_fqdn }}:27017/message_db?authSource=admin

  deploy-frontend:
    needs: [deploy-mongo, deploy-backend]
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Determine Image Tag
        id: get_tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Deploy Frontend Container App
        id: deploy-frontend-container
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: ${{ env.FRONTEND_APP_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.ACA_ENV_NAME }}
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_APP_NAME }}:${{ steps.get_tag.outputs.tag }}

          registryUrl: ${{ secrets.ACR_LOGIN_SERVER }}
          registryUsername: ${{ secrets.ACR_USERNAME }}
          registryPassword: ${{ secrets.ACR_PASSWORD }}

          targetPort: 80
          ingress: "external"
          
          environmentVariables: "BACKEND_URL=https://${{ needs.deploy-backend.outputs.backend_fqdn }}"

      - name: Display Frontend URL
        run: |
          echo "Your application is accessible at: https://${{ steps.deploy-frontend-container.outputs.fqdn }}"
