name: Deploy to Azure Container Apps

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (e.g., latest)"
        required: true
        default: "latest"
  workflow_run:
    workflows: ["Build and Push Docker Images to ACR"]
    types: [completed]
    branches: [main]

env:
  RESOURCE_GROUP: "exr-dvo-intern-inc"
  ACA_ENV_NAME: "messageapp-env-susmitha" # <-- MUST match the script
  MONGO_APP_NAME: "mongo-app-susmitha"
  BACKEND_APP_NAME: "backend-app-susmitha"
  FRONTEND_APP_NAME: "frontend-app-susmitha"
jobs:
  # JOB 1: DEPLOY THE DATABASE FIRST
  # In .github/workflows/deploy-to-aca.yml

  # JOB 1: DEPLOY THE DATABASE FIRST
  deploy-mongo:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      mongo_fqdn: ${{ steps.deploy-mongo-container.outputs.fqdn }}
      
    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Mongo Container App
        id: deploy-mongo-container
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: ${{ env.MONGO_APP_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.ACA_ENV_NAME }}
          imageToDeploy: mongo:latest
          
          ingress: "internal"
          targetPort: 27017 # Explicitly set the target port for Mongo
          
          # --- FIX #1: GUARANTEE SUFFICIENT RESOURCES ---
          cpu: "0.5"
          memory: "1.0Gi"
          # ----------------------------------------------

          # --- FIX #2: ADD A PATIENT STARTUP PROBE ---
          # This tells Azure to wait up to 3 minutes (18 * 10s) for Mongo to start
          # before marking it as unhealthy. This is crucial for databases.
          startupProbe:
            type: "tcp"
            port: 27017
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 18
          # --------------------------------------------

          environmentVariables: |
            MONGO_INITDB_ROOT_USERNAME=${{ secrets.MONGO_USERNAME }}
            MONGO_INITDB_ROOT_PASSWORD=${{ secrets.MONGO_PASSWORD }}

  # JOB 2: DEPLOY THE BACKEND, WHICH DEPENDS ON THE DATABASE
  deploy-backend:
    needs: deploy-mongo # This is crucial. It waits for the mongo job to finish.
    runs-on: ubuntu-latest
    outputs:
      backend_fqdn: ${{ steps.deploy-backend-container.outputs.fqdn }}

    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Determine Image Tag
        id: get_tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Deploy Backend Container App
        id: deploy-backend-container
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: ${{ env.BACKEND_APP_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.ACA_ENV_NAME }}
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.BACKEND_APP_NAME }}:${{ steps.get_tag.outputs.tag }}

          registryUrl: ${{ secrets.ACR_LOGIN_SERVER }}
          registryUsername: ${{ secrets.ACR_USERNAME }}
          registryPassword: ${{ secrets.ACR_PASSWORD }}

          targetPort: 8080
          ingress: "internal"
          
          # THIS IS THE KEY CHANGE: We construct the connection string here
          environmentVariables: |
            JAVA_TOOL_OPTIONS=-Duser.timezone=Asia/Calcutta
            SPRING_DATA_MONGODB_URI=mongodb://${{ secrets.MONGO_USERNAME }}:${{ secrets.MONGO_PASSWORD }}@${{ needs.deploy-mongo.outputs.mongo_fqdn }}:27017/message_db?authSource=admin

  # JOB 3: DEPLOY THE FRONTEND, WHICH DEPENDS ON THE BACKEND
  deploy-frontend:
    needs: [deploy-mongo, deploy-backend] # Waits for both previous jobs
    runs-on: ubuntu-latest

    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Determine Image Tag
        id: get_tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Deploy Frontend Container App
        id: deploy-frontend-container
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: ${{ env.FRONTEND_APP_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.ACA_ENV_NAME }}
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_APP_NAME }}:${{ steps.get_tag.outputs.tag }}

          registryUrl: ${{ secrets.ACR_LOGIN_SERVER }}
          registryUsername: ${{ secrets.ACR_USERNAME }}
          registryPassword: ${{ secrets.ACR_PASSWORD }}

          targetPort: 80
          ingress: "external"
          environmentVariables: "BACKEND_URL=https://${{ needs.deploy-backend.outputs.backend_fqdn }}"

      - name: Display Frontend URL
        run: |
          echo "Your application is accessible at: https://${{ steps.deploy-frontend-container.outputs.fqdn }}"